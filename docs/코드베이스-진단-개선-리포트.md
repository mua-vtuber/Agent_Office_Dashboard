# 코드베이스 진단 및 개선 리포트 (2026-02-18)

## 1. 목적
현재 코드 기준으로 구조/품질을 점검하고, 다음 작업에서 우선 수정해야 할 항목을 정리한다.
기준 원칙:
- 설정 기반 동적 구현 (하드코딩 금지)
- 실패 은닉 금지 (폴백 대신 명시적 오류 노출)
- 작업량보다 코드 품질 우선
- 구조 효율 우선

## 2. 진단 범위
- Backend: `apps/backend/src/**`
- Frontend: `apps/frontend/src/**`
- Schema: `packages/shared-schema/src/**`
- 수집 스크립트: `scripts/hooks/forward-to-aod.sh`

## 3. 핵심 진단 결과

### 3.1 설정 기반 동적 구현 미흡 (하드코딩 잔존)
1. 오피스 레이아웃/구역 상수 하드코딩
- 파일: `apps/frontend/src/pages/OfficePage.tsx`
- 이슈:
  - `DEFAULT_SEAT_POINTS`, `DEFAULT_MEETING_SPOTS`, `pantryZone`, `roamZone`, `CW`, `CH` 고정값 사용
  - 일부는 settings로 덮지만 기본이 코드에 강결합
- 영향:
  - 설정 변경 시 UI와 상태 연출 규칙이 분리될 위험

2. 설정 옵션 하드코딩
- 파일: `apps/frontend/src/pages/SettingsPage.tsx`
- 이슈:
  - layout profile 선택값이 `kr_t_left_v2` 단일 고정
- 영향:
  - 다중 프로필 확장 시 코드 수정이 필수

3. 이벤트/동기화 간격 하드코딩
- 파일: `apps/frontend/src/pages/DashboardPage.tsx`
- 이슈:
  - `DEFAULT_SYNC_INTERVAL_SEC = 30` 고정
- 영향:
  - 운영 설정(`operations.snapshot_sync_interval_sec`)과 동기화 정책 불일치

### 3.2 실패 은닉(폴백) 사용 지점
1. API/WS 주소 폴백 은닉
- 파일: `apps/frontend/src/lib/constants.ts`
- 이슈:
  - store 접근 실패 시 `127.0.0.1` 기본값으로 조용히 폴백
- 영향:
  - 환경 오설정이 즉시 드러나지 않고 잘못된 서버에 연결될 수 있음

2. 데이터 로드 실패 은닉
- 파일: `apps/frontend/src/pages/OfficePage.tsx`
- 이슈:
  - `/api/settings/app` 호출에 `.catch(() => null)` 적용
- 영향:
  - 설정 API 장애가 UI에 표시되지 않음

3. 주기 동기화 실패 은닉
- 파일: `apps/frontend/src/pages/DashboardPage.tsx`
- 이슈:
  - interval 동기화 실패 `catch {}`
- 영향:
  - 운영자가 데이터 정합성 문제를 인지하기 어려움

4. Hook 전달 실패 은닉
- 파일: `scripts/hooks/forward-to-aod.sh`
- 이슈:
  - `curl ... || true`, 빈 payload `exit 0` 등 실패 무시
- 영향:
  - 수집 실패가 CLI 사용자에게 노출되지 않아 진단 지연

### 3.3 구조적으로 구현됐지만 UI와 연결이 약한 항목
1. 동적 전이 규칙 저장 vs 상태머신 미적용
- 파일: `apps/frontend/src/components/settings/TransitionRulesEditor.tsx`
- 파일: `apps/backend/src/services/state-machine.ts`
- 이슈:
  - UI에서 `transition_rules` 저장 가능하지만 실제 전이 계산은 고정 테이블만 사용
- 영향:
  - "설정 변경 즉시 반영" 기대와 실제 동작 불일치

2. 번역 설정은 있으나 오류 모델 불명확
- 파일: `apps/backend/src/services/translator.ts`
- 이슈:
  - 실패 시 문자열 `[Translation Error: ...]`을 데이터로 저장
- 영향:
  - 사용자 친화 오류 UI 대신 도메인 데이터 오염 가능성

### 3.4 레거시/중복 구조
1. 설정 조회 경로 이원화
- 파일: `apps/frontend/src/stores/app-settings-store.ts`
- 파일: `apps/frontend/src/pages/SettingsPage.tsx`
- 파일: `apps/frontend/src/pages/OfficePage.tsx`
- 이슈:
  - 일부는 store 기반, 일부는 page별 직접 `apiGet('/api/settings/...')`
- 영향:
  - 설정 캐시/동기화 정책 분산, 버그 추적 비용 증가

2. 상태 기본값 중복
- 파일: `packages/shared-schema/src/settings.ts`
- 파일: `apps/frontend/src/components/settings/SeatEditor.tsx`
- 이슈:
  - 좌석 기본값이 schema 기본값/컴포넌트 상수로 중복 정의
- 영향:
  - 기준값 변경 시 일관성 깨질 수 있음

## 4. 우선순위 개선안 (진행 상태)

### P0 (즉시)
1. [x] 실패 은닉 제거
- 대상:
  - `apps/frontend/src/pages/OfficePage.tsx`
  - `apps/frontend/src/pages/DashboardPage.tsx`
  - `apps/frontend/src/lib/constants.ts`
  - `scripts/hooks/forward-to-aod.sh`
- 원칙:
  - catch에서 무시하지 말고 `useErrorStore` 또는 명시적 에러 응답/로그로 노출

2. [x] 동적 전이 규칙 실제 적용
- 대상: `apps/backend/src/services/state-machine.ts`
- 원칙:
  - settings의 `transition_rules`를 정규화/검증 후 transition table에 병합

### P1 (단기)
1. [x] 오피스 레이아웃 완전 설정화
- 대상: `apps/frontend/src/pages/OfficePage.tsx`, `packages/shared-schema/src/settings.ts`
- 원칙:
  - 구역/캔버스/좌석/미팅스팟을 모두 settings로 이동

2. [x] 동기화 주기 설정 연동
- 대상: `apps/frontend/src/pages/DashboardPage.tsx`
- 원칙:
  - `operations.snapshot_sync_interval_sec` 사용

### P2 (중기)
1. [x] 설정 접근 단일화
- 대상: frontend 전역
- 원칙:
  - 모든 설정 조회/갱신을 `app-settings-store` 경유로 통일

2. [x] 번역 오류 UX 분리
- 대상: `apps/backend/src/services/translator.ts`, 프론트 에러 표시 계층
- 원칙:
  - 도메인 데이터에 에러 문자열 주입 대신 별도 오류 채널 사용

3. [x] 운영 통합 가시성 강화 (추가)
- 대상: `apps/backend/src/routes/integration.ts`, `scripts/hooks/forward-to-aod.sh`, `apps/frontend/src/pages/SettingsPage.tsx`, `apps/frontend/src/pages/DashboardPage.tsx`
- 원칙:
  - hooks 설정 여부뿐 아니라 최근 이벤트 정체/전송 실패를 운영 화면에 명시

## 5. 완료 작업 내역

### 5.1 오류 은닉 제거 / 오류 노출
- `apps/frontend/src/pages/OfficePage.tsx`
  - settings 로드 실패 무시 제거, 오류 모달 노출로 전환
- `apps/frontend/src/pages/DashboardPage.tsx`
  - interval 동기화 실패 `catch {}` 제거, 오류 1회 이상 노출
  - 동기화 주기 settings 연동
- `apps/frontend/src/lib/constants.ts`
  - 무조건 `127.0.0.1` 폴백 제거, 미설정 시 명시적 오류
- `scripts/hooks/forward-to-aod.sh`
  - `set -euo pipefail`, 실패 시 stderr + non-zero 종료

### 5.2 동적 상태 전이/설정 기반 구조
- `apps/backend/src/services/state-machine.ts`
  - `settings.transition_rules` 병합 적용
  - status/event 유효성 검증 후 규칙 반영
- `packages/shared-schema/src/settings.ts`
  - `office_layout`에 `canvas_width`, `canvas_height`, `zones` 추가
  - 좌석/미팅 기본값을 스키마 기본값으로 통합
- `apps/frontend/src/pages/OfficePage.tsx`
  - 좌석/미팅/구역/캔버스 하드코딩 제거, settings 기반 렌더링
- `apps/frontend/src/components/settings/SeatEditor.tsx`
  - 좌석 기본값 중복 제거, `defaultSettings` 재사용

### 5.3 설정 저장/검증 체계 정리
- `apps/backend/src/routes/settings.ts`
  - `PUT /api/settings`, `PUT /api/settings/:key` 스키마 검증 추가
  - 잘못된 payload는 400 + 구체 메시지 반환
- `apps/frontend/src/stores/app-settings-store.ts`
  - update 실패를 throw하여 호출부가 명시적으로 처리
- `apps/frontend/src/pages/SettingsPage.tsx`
  - 저장 경로를 store `update()` 단일 경로로 통일
  - 레거시 키(`ui_language`, `ui_motion`, top-level `layout_profile`) 제거
- `apps/backend/scripts/seed-mock.ts`
  - 최신 settings 스키마로 갱신

### 5.4 번역 오류 분리/운영 가시성 강화
- `apps/backend/src/services/translator.ts`
  - 반환값을 `{ text, error }` 구조로 변경
  - 실패 시 원문 유지 + 오류 채널 분리
- `apps/backend/src/routes/ingest.ts`
  - 번역 실패 시 `runtime_error` 브로드캐스트
- `apps/frontend/src/stores/ws-store.ts`
  - `runtime_error` 수신 시 오류 모달 연동
- `apps/frontend/src/components/settings/TransitionRulesEditor.tsx`
  - 중복/충돌 규칙 검증 및 저장 차단
- `apps/backend/src/routes/integration.ts`
  - 통합 상태에 `issues`, `last_hook_event_age_sec` 추가
  - `hook_delivery_failed` 감지
- `apps/backend/src/storage/hook-errors-repo.ts`
  - hook 오류 저장/조회 저장소 추가
- `apps/backend/src/storage/db.ts`
  - `integration_hook_errors` 테이블/인덱스/마이그레이션(v3) 추가
- `scripts/hooks/forward-to-aod.sh`
  - `/api/integration/hook-error` 보고 경로 추가
- `apps/backend/src/routes/integration.ts`
  - `GET /api/integration/hook-errors` 페이징 API 추가
  - `masking_keys` 기반 민감정보 마스킹 적용
- `apps/frontend/src/pages/SettingsPage.tsx`
  - hook 오류 히스토리/상세/추가 로딩 UI 추가
- `apps/frontend/src/pages/DashboardPage.tsx`
  - 통합 이슈 상세 배너 표시
- `apps/frontend/src/i18n/index.ts`
  - 관련 운영/검증/오류 문구 추가

## 6. 검증 기준(현재 상태)
- [x] 하드코딩 상수 제거 후 settings 단일 소스 유지
- [x] 모든 네트워크/파싱 실패가 사용자 UI에 표시됨
- [x] 설정 UI 변경 항목이 실제 런타임 동작에 반영됨
- [ ] typecheck + smoke 시나리오 통과
  - `pnpm typecheck`: 통과
  - `scripts/smoke-e2e.mjs`: 백엔드 미기동 환경에서 `fetch failed`
